"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const e=require("exceljs"),t=require("file-saver");class o{listeners=new Map;on(e,t,o={}){this.listeners.has(e)||this.listeners.set(e,[]);const s={type:e,listener:t,options:{once:!1,async:!1,priority:0,stopPropagation:!1,...o},id:this.generateId(),active:!0,timestamp:new Date};return this.listeners.get(e).push(s),this.listeners.get(e).sort((e,t)=>(t.options.priority||0)-(e.options.priority||0)),s.id}once(e,t,o={}){return this.on(e,t,{...o,once:!0})}off(e,t){const o=this.listeners.get(e);if(!o)return!1;const s=o.findIndex(e=>e.id===t);return-1!==s&&(o.splice(s,1),!0)}offAll(e){const t=this.listeners.get(e);if(!t)return 0;const o=t.length;return this.listeners.delete(e),o}async emit(e){const t=e.type||"default",o=this.listeners.get(t);if(!o||0===o.length)return;const s=o.filter(e=>e.active);for(const i of s)try{if(i.options.once&&(i.active=!1),i.options.async?await i.listener(e):i.listener(e),i.options.stopPropagation)break}catch(r){console.error(`Error in event listener for ${t}:`,r)}this.cleanupInactiveListeners(t)}emitSync(e){const t=e.type||"default",o=this.listeners.get(t);if(!o||0===o.length)return;const s=o.filter(e=>e.active);for(const i of s)try{if(i.options.once&&(i.active=!1),i.listener(e),i.options.stopPropagation)break}catch(r){console.error(`Error in event listener for ${t}:`,r)}this.cleanupInactiveListeners(t)}clear(){this.listeners.clear()}getListeners(e){return this.listeners.get(e)||[]}getListenerCount(e){return this.listeners.get(e)?.length||0}getEventTypes(){return Array.from(this.listeners.keys())}generateId(){return Math.random().toString(36).substr(2,9)}cleanupInactiveListeners(e){const t=this.listeners.get(e);if(t){const o=t.filter(e=>e.active);o.length!==t.length&&this.listeners.set(e,o)}}}var s=(e=>(e.STRING="string",e.NUMBER="number",e.BOOLEAN="boolean",e.DATE="date",e.PERCENTAGE="percentage",e.CURRENCY="currency",e.LINK="link",e.FORMULA="formula",e))(s||{}),r=(e=>(e.GENERAL="General",e.NUMBER="#,##0",e.NUMBER_DECIMALS="#,##0.00",e.CURRENCY="$#,##0.00",e.CURRENCY_INTEGER="$#,##0",e.PERCENTAGE="0%",e.PERCENTAGE_DECIMALS="0.00%",e.DATE="dd/mm/yyyy",e.DATE_TIME="dd/mm/yyyy hh:mm",e.TIME="hh:mm:ss",e.CUSTOM="custom",e))(r||{}),i=(e=>(e.LEFT="left",e.CENTER="center",e.RIGHT="right",e.FILL="fill",e.JUSTIFY="justify",e.CENTER_CONTINUOUS="centerContinuous",e.DISTRIBUTED="distributed",e))(i||{}),n=(e=>(e.TOP="top",e.MIDDLE="middle",e.BOTTOM="bottom",e.DISTRIBUTED="distributed",e.JUSTIFY="justify",e))(n||{}),l=(e=>(e.THIN="thin",e.MEDIUM="medium",e.THICK="thick",e.DOTTED="dotted",e.DASHED="dashed",e.DOUBLE="double",e.HAIR="hair",e.MEDIUM_DASHED="mediumDashed",e.DASH_DOT="dashDot",e.MEDIUM_DASH_DOT="mediumDashDot",e.DASH_DOT_DOT="dashDotDot",e.MEDIUM_DASH_DOT_DOT="mediumDashDotDot",e.SLANT_DASH_DOT="slantDashDot",e))(l||{}),a=(e=>(e.NORMAL="normal",e.BOLD="bold",e.ITALIC="italic",e.BOLD_ITALIC="bold italic",e))(a||{}),c=(e=>(e.VALIDATION_ERROR="VALIDATION_ERROR",e.BUILD_ERROR="BUILD_ERROR",e.STYLE_ERROR="STYLE_ERROR",e.WORKSHEET_ERROR="WORKSHEET_ERROR",e.CELL_ERROR="CELL_ERROR",e))(c||{});class h{config;tables=[];currentRow=1;currentCol=1;headerPointers=new Map;isBuilt=!1;headers=[];subHeaders=[];body=[];footers=[];images=[];rowGroups=[];columnGroups=[];namedRanges=[];excelTables=[];hiddenRows=new Set;hiddenColumns=new Set;pivotTables=[];slicers=[];watermarks=[];dataConnections=[];customStyles;theme;constructor(e){this.config=e}addHeader(e){return this.headers.push(e),this}addSubHeaders(e){return this.subHeaders.push(...e),this}addRow(e){return Array.isArray(e)?this.body.push(...e):this.body.push(e),this}addFooter(e){return Array.isArray(e)?this.footers.push(...e):this.footers.push(e),this}addTable(e={}){const t={name:e.name||`Table_${this.tables.length+1}`,headers:e.headers||[],subHeaders:e.subHeaders||[],body:e.body||[],footers:e.footers||[],showBorders:!1!==e.showBorders,showStripes:!1!==e.showStripes,style:e.style||"TableStyleLight1",...e};return this.tables.push(t),this}finalizeTable(){0===this.tables.length&&this.addTable();const e=this.tables[this.tables.length-1];if(!e)throw new Error("No se pudo obtener la tabla actual");return this.headers.length>0&&(e.headers=[...e.headers||[],...this.headers]),this.subHeaders.length>0&&(e.subHeaders=[...e.subHeaders||[],...this.subHeaders]),this.body.length>0&&(e.body=[...e.body||[],...this.body]),this.footers.length>0&&(e.footers=[...e.footers||[],...this.footers]),this.headers=[],this.subHeaders=[],this.body=[],this.footers=[],this}getTable(e){return this.tables.find(t=>t.name===e)}addImage(e){return this.images.push(e),this}groupRows(e,t,o=!1){return this.rowGroups.push({start:e,end:t,collapsed:o}),this}groupColumns(e,t,o=!1){return this.columnGroups.push({start:e,end:t,collapsed:o}),this}addNamedRange(e,t,o){let s;if("string"==typeof t)s=t;else{s=`${t.start.reference||`${this.numberToColumnLetter(t.start.col)}${t.start.row}`}:${t.end.reference||`${this.numberToColumnLetter(t.end.col)}${t.end.row}`}`}const r={name:e,range:s};return void 0!==o&&(r.scope=o),this.namedRanges.push(r),this}addExcelTable(e){return this.excelTables.push(e),this}hideRows(e){return(Array.isArray(e)?e:[e]).forEach(e=>this.hiddenRows.add(e)),this}showRows(e){return(Array.isArray(e)?e:[e]).forEach(e=>this.hiddenRows.delete(e)),this}hideColumns(e){return(Array.isArray(e)?e:[e]).forEach(e=>{const t="string"==typeof e?this.columnLetterToNumber(e):e;this.hiddenColumns.add(t)}),this}showColumns(e){return(Array.isArray(e)?e:[e]).forEach(e=>{const t="string"==typeof e?this.columnLetterToNumber(e):e;this.hiddenColumns.delete(t)}),this}addPivotTable(e){return this.pivotTables.push(e),this}addSlicer(e){return this.slicers.push(e),this}addWatermark(e){return this.watermarks.push(e),this}addDataConnection(e){return this.dataConnections.push(e),this}async build(e,t={}){const o=e.addWorksheet(this.config.name,{properties:{defaultRowHeight:this.config.defaultRowHeight||20,tabColor:this.config.tabColor},pageSetup:this.config.pageSetup});this.customStyles=e.__customStyles,this.theme=e.__theme;let s=1;if(this.tables.length>0){let e=s;for(let t=0;t<this.tables.length;t++){const r=this.tables[t];r&&(e=s,s=await this.buildTable(o,r,s,t>0),r.autoFilter&&s>e&&this.applyAutoFilter(o,r,e,s-1))}}else s=await this.buildLegacyContent(o,s);this.config.autoFilter?.enabled&&this.applyWorksheetAutoFilter(o,s),this.applyViews(o),this.config.protected&&o.protect(this.config.protectionPassword||"",{selectLockedCells:!1,selectUnlockedCells:!0,formatCells:!1,formatColumns:!1,formatRows:!1,insertColumns:!1,insertRows:!1,insertHyperlinks:!1,deleteColumns:!1,deleteRows:!1,sort:!1,autoFilter:!1,pivotTables:!1});for(const r of this.images)await this.applyImage(o,r);for(const r of this.rowGroups)this.applyRowGrouping(o,r.start,r.end,r.collapsed);for(const r of this.columnGroups)this.applyColumnGrouping(o,r.start,r.end,r.collapsed);for(const r of this.namedRanges)e.definedNames.add(r.name,r.range);for(const r of this.excelTables)this.applyExcelTable(o,r);this.applyAdvancedPrintSettings(o),this.applyHiddenRowsColumns(o);for(const r of this.pivotTables)await this.applyPivotTable(o,r);for(const r of this.slicers)await this.applySlicer(o,r);for(const r of this.watermarks)await this.applyWatermark(o,r);for(const r of this.dataConnections)await this.applyDataConnection(e,r);this.isBuilt=!0}async buildTable(e,t,o,s=!1){let r=o;if(s&&(r+=2),t.headers&&t.headers.length>0)for(const i of t.headers){const o=e.getRow(r).getCell(1);if(i.richText&&i.richText.length>0?o.value={richText:i.richText.map(e=>({text:e.text,font:e.font?{name:e.font}:void 0,size:e.size,color:e.color?this.convertColorToExcelJS(e.color):void 0,bold:e.bold,italic:e.italic,underline:e.underline,strike:e.strikethrough})).filter(e=>void 0!==e.text)}:o.value=this.processCellValue(i),i.mergeCell){const o=this.calculateTableMaxColumns(t);e.mergeCells(r,1,r,o)}i.styles&&e.getRow(r).eachCell(e=>{e.style=this.convertStyle(i.styles)}),i.cellProtection?o.protection={locked:i.cellProtection.locked??!0,hidden:i.cellProtection.hidden??!1}:void 0!==i.protected&&(o.protection={locked:i.protected,hidden:!1}),this.applyCellDimensions(e,r,1,i),i.comment&&this.applyCellComment(e,r,1,i.comment),i.validation&&this.applyDataValidation(e,r,1,i.validation),i.styles?.conditionalFormats&&this.applyConditionalFormatting(e,r,1,i.styles.conditionalFormats),r++}if(t.subHeaders&&t.subHeaders.length>0&&(r=this.buildNestedHeaders(e,r,t.subHeaders)),t.body&&t.body.length>0)for(const i of t.body)r=this.addDataRowRecursive(e,r,i);if(t.footers&&t.footers.length>0)for(const i of t.footers)r=this.addFooterRow(e,r,i);return(t.showBorders||t.showStripes)&&this.applyTableStyle(e,t,o,r-1),r}async buildLegacyContent(e,t){let o=t;this.headers.length>0&&this.headers.forEach(t=>{e.addRow([this.processCellValue(t)]),t.mergeCell&&e.mergeCells(o,1,o,this.getMaxColumns()||1),t.styles&&e.getRow(o).eachCell(e=>{e.style=this.convertStyle(t.styles)}),this.applyCellDimensions(e,o,1,t),t.comment&&this.applyCellComment(e,o,1,t.comment),t.validation&&this.applyDataValidation(e,o,1,t.validation),t.styles?.conditionalFormats&&this.applyConditionalFormatting(e,o,1,t.styles.conditionalFormats),o++}),this.subHeaders.length>0&&(o=this.buildNestedHeaders(e,o,this.subHeaders));for(const s of this.body)o=this.addDataRowRecursive(e,o,s);if(this.footers.length>0)for(const s of this.footers)o=this.addFooterRow(e,o,s);return o}calculateTableMaxColumns(e){let t=0;if(e.subHeaders&&e.subHeaders.length>0)for(const o of e.subHeaders)t+=this.calculateHeaderColSpan(o);return t||1}applyTableStyle(e,t,o,s){const r=this.calculateTableMaxColumns(t);if(t.showBorders)for(let i=o;i<=s;i++)for(let t=1;t<=r;t++){const o=e.getRow(i).getCell(t);o.style||(o.style={}),o.style.border||(o.style.border={top:{style:"thin",color:{argb:"FF8EAADB"}},left:{style:"thin",color:{argb:"FF8EAADB"}},bottom:{style:"thin",color:{argb:"FF8EAADB"}},right:{style:"thin",color:{argb:"FF8EAADB"}}})}if(t.showStripes)for(let i=o;i<=s;i++)if((i-o)%2==1)for(let t=1;t<=r;t++){const o=e.getRow(i).getCell(t);o.style||(o.style={}),o.style.fill||(o.style.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFF2F2F2"}})}}buildNestedHeaders(e,t,o){let s=t;const r=this.getMaxHeaderDepth(o);for(let i=0;i<r;i++){const t=e.getRow(s);let r=1;for(const n of o)if(0===i){const o=this.getHeaderAtDepth(n,i,r),l=t.getCell(r);l.value=this.processCellValue(n),o.style&&(l.style=this.convertStyle(o.style)),this.applyCellDimensions(e,s,r,n),n.comment&&this.applyCellComment(e,s,r,n.comment),n.validation&&this.applyDataValidation(e,s,r,n.validation),n.styles?.conditionalFormats&&this.applyConditionalFormatting(e,s,r,n.styles.conditionalFormats),r+=o.colSpan}else if(n.children&&n.children.length>0)for(const o of n.children){const i=t.getCell(r);i.value=this.processCellValue(o),(o.styles||n.styles)&&(i.style=this.convertStyle(o.styles||n.styles)),this.applyCellDimensions(e,s,r,o),o.comment&&this.applyCellComment(e,s,r,o.comment),o.validation&&this.applyDataValidation(e,s,r,o.validation),o.styles?.conditionalFormats&&this.applyConditionalFormatting(e,s,r,o.styles.conditionalFormats),r+=this.calculateHeaderColSpan(o)}else{t.getCell(r).value=null,r+=1}s++}return this.applyAllMerges(e,t,s-1,o),s}getHeaderAtDepth(e,t,o){const s=this.calculateHeaderColSpan(e);if(0===t){const t=s>1?{start:o,end:o+s-1}:null;return{value:"string"==typeof e.value?e.value:String(e.value||""),style:e.styles,colSpan:s,mergeRange:t}}if(e.children&&e.children.length>0){const s=e.children[t];if(s){const t=this.calculateHeaderColSpan(s),r=t>1?{start:o,end:o+t-1}:null;return{value:"string"==typeof s.value?s.value:String(s.value||""),style:s.styles||e.styles,colSpan:t,mergeRange:r}}}return{value:null,style:null,colSpan:1}}applyAllMerges(e,t,o,s){this.getMaxHeaderDepth(s)<=1||this.applySmartMerges(e,t,o,s)}applySmartMerges(e,t,o,s){if(this.getMaxHeaderDepth(s)<=1)return;let r=1;for(const i of s)this.applySmartMergesForHeader(e,t,o,i,r),r+=this.calculateHeaderColSpan(i)}applySmartMergesForHeader(e,t,o,s,r){const i=this.calculateHeaderColSpan(s);if(s.children&&0!==s.children.length){i>1&&e.mergeCells(t,r,t,r+i-1);let n=r;for(const r of s.children)this.applySmartMergesForHeader(e,t+1,o,r,n),n+=this.calculateHeaderColSpan(r)}else e.mergeCells(t,r,o,r+i-1)}calculateHeaderColSpan(e){return e.children&&0!==e.children.length?e.children.reduce((e,t)=>e+this.calculateHeaderColSpan(t),0):1}getMaxHeaderDepth(e){let t=1;for(const o of e)if(o.children&&o.children.length>0){const e=this.getMaxHeaderDepth(o.children);t=Math.max(t,e+1)}return t}getMaxColumns(){let e=0;for(const t of this.subHeaders)e+=this.calculateHeaderColSpan(t);return e}validate(){return this.headers.length||this.body.length?{success:!0,data:!0}:{success:!1,error:{type:c.VALIDATION_ERROR,message:"La hoja no tiene datos"}}}calculateDataColumnPositions(){const e={};let t=1;for(const o of this.subHeaders)if(o.children&&o.children.length>0)for(const s of o.children)s.key&&(e[s.key]=t),s.value&&(e[String(s.value)]=t),t++;else o.key&&(e[o.key]=t),o.value&&(e[String(o.value)]=t),t++;return e}addFooterRow(e,t,o){const s=this.calculateDataColumnPositions();let r;o.key&&s[o.key]?r=s[o.key]:o.header&&s[o.header]&&(r=s[o.header]),void 0===r&&(r=1);const i=e.getRow(t),n=i.getCell(r);if(n.value=this.processCellValue(o),o.styles)n.style=this.convertStyle(o.styles);else if(o.styleName){const e=this.getPredefinedStyle(o.styleName);e&&(n.style=this.convertStyle(e))}else{const e=this.getThemeStyle("footer");e&&(n.style=this.convertStyle(e))}if(o.numberFormat&&(n.numFmt=o.numberFormat),this.applyCellDimensions(e,t,r,o),o.comment&&this.applyCellComment(e,t,r,o.comment),o.validation&&this.applyDataValidation(e,t,r,o.validation),o.styles?.conditionalFormats&&this.applyConditionalFormatting(e,t,r,o.styles.conditionalFormats),o.mergeCell&&o.mergeTo&&e.mergeCells(t,r,t,o.mergeTo),o.children&&o.children.length>0)for(const l of o.children)if(l){let o;if(l.key&&s[l.key]?o=s[l.key]:l.header&&s[l.header]&&(o=s[l.header]),void 0!==o){const s=i.getCell(o);s.value=this.processCellValue(l),l.styles&&(s.style=this.convertStyle(l.styles)),l.numberFormat&&(s.numFmt=l.numberFormat),this.applyCellDimensions(e,t,o,l),l.comment&&this.applyCellComment(e,t,o,l.comment),l.validation&&this.applyDataValidation(e,t,o,l.validation),l.styles?.conditionalFormats&&this.applyConditionalFormatting(e,t,o,l.styles.conditionalFormats)}}return o.jump?t+1:t}applyCellDimensions(e,t,o,s){if(void 0!==s.rowHeight){e.getRow(t).height=s.rowHeight}if(void 0!==s.colWidth){e.getColumn(o).width=s.colWidth}}applyCellComment(e,t,o,s){if(!s||""===s.trim())return;const r=e.getRow(t).getCell(o);"string"==typeof s&&(r.note=s)}applyDataValidation(e,t,o,s){if(!s)return;const r=e.getRow(t).getCell(o),i={type:"time"===s.type?"date":s.type,allowBlank:s.allowBlank??!0,formulae:[]};s.operator&&(i.operator=s.operator),void 0!==s.formula1&&("string"==typeof s.formula1?i.formulae=[s.formula1]:s.formula1 instanceof Date?i.formulae=[s.formula1.toISOString()]:i.formulae=[s.formula1]),void 0!==s.formula2&&(i.formulae||(i.formulae=[]),"string"==typeof s.formula2?i.formulae.push(s.formula2):s.formula2 instanceof Date?i.formulae.push(s.formula2.toISOString()):i.formulae.push(s.formula2)),s.showErrorMessage&&(i.showErrorMessage=!0,s.errorMessage&&(i.error=s.errorMessage)),s.showInputMessage&&(i.showInputMessage=!0,s.inputMessage&&(i.prompt=s.inputMessage)),r.dataValidation=i}applyConditionalFormatting(e,t,o,s){if(!s||0===s.length)return;const r=e.getRow(t).getCell(o).address;s.forEach((t,o)=>{const s={type:t.type,priority:t.priority??o+1,stopIfTrue:t.stopIfTrue??!1};if(t.operator&&(s.operator=t.operator),t.formula?s.formulae=[t.formula]:t.values&&t.values.length>0&&(s.formulae=t.values.map(e=>"string"==typeof e?e:e instanceof Date?e.toISOString():String(e))),t.style){const e=this.convertStyle(t.style);s.style=e}e.addConditionalFormatting({ref:r,rules:[s]})})}applyAutoFilter(e,t,o,s){if(!t.autoFilter)return;const r=this.calculateTableMaxColumns(t),i=o,n=s;r>0&&n>=i&&(e.autoFilter={from:{row:i,column:1},to:{row:n,column:r}})}applyWorksheetAutoFilter(e,t){const o=this.config.autoFilter;if(!o||!o.enabled)return;if(o.range)return void(e.autoFilter={from:{row:o.range.start?.row||1,column:o.range.start?.col||1},to:{row:o.range.end?.row||t,column:o.range.end?.col||e.columnCount||1}});if(void 0!==o.startRow||void 0!==o.endRow||void 0!==o.startColumn||void 0!==o.endColumn)return void(e.autoFilter={from:{row:o.startRow||1,column:o.startColumn||1},to:{row:o.endRow||t,column:o.endColumn||e.columnCount||1}});const s=this.headers.length>0?this.headers.length+(this.subHeaders.length>0?this.getMaxHeaderDepth(this.subHeaders):0):1,r=this.getMaxColumns()||e.columnCount||1;t>=s&&r>0&&(e.autoFilter={from:{row:s,column:1},to:{row:t,column:r}})}processCellValue(e){if(e.link||e.type===s.LINK){const t=e.link||("string"==typeof e.value?e.value:"");if(!t||""===t.trim())return e.value;const o=e.mask||e.value||t;return{text:String(o),hyperlink:t}}return e.value}addDataRowRecursive(e,t,o){const s=this.calculateDataColumnPositions();let r;o.key&&s[o.key]?r=s[o.key]:o.header&&s[o.header]&&(r=s[o.header]),void 0===r&&(r=1);const i=e.getRow(t),n=i.getCell(r);if(o.richText&&o.richText.length>0?n.value={richText:o.richText.map(e=>({text:e.text,font:e.font?{name:e.font}:void 0,size:e.size,color:e.color?this.convertColorToExcelJS(e.color):void 0,bold:e.bold,italic:e.italic,underline:e.underline,strike:e.strikethrough})).filter(e=>void 0!==e.text)}:n.value=this.processCellValue(o),o.styles)n.style=this.convertStyle(o.styles);else if(o.styleName){const e=this.getPredefinedStyle(o.styleName);e&&(n.style=this.convertStyle(e))}else{const e=this.getThemeStyle("body",t);e&&(n.style=this.convertStyle(e))}if(o.numberFormat&&(n.numFmt=o.numberFormat),o.cellProtection?n.protection={locked:o.cellProtection.locked??!0,hidden:o.cellProtection.hidden??!1}:void 0!==o.protected&&(n.protection={locked:o.protected,hidden:!1}),this.applyCellDimensions(e,t,r,o),o.comment&&this.applyCellComment(e,t,r,o.comment),o.validation&&this.applyDataValidation(e,t,r,o.validation),o.styles?.conditionalFormats&&this.applyConditionalFormatting(e,t,r,o.styles.conditionalFormats),o.children&&o.children.length>0)for(const l of o.children)if(l){let o;if(l.key&&s[l.key]?o=s[l.key]:l.header&&s[l.header]&&(o=s[l.header]),void 0!==o){const s=i.getCell(o);s.value=this.processCellValue(l),l.styles&&(s.style=this.convertStyle(l.styles)),l.numberFormat&&(s.numFmt=l.numberFormat),this.applyCellDimensions(e,t,o,l),l.comment&&this.applyCellComment(e,t,o,l.comment),l.validation&&this.applyDataValidation(e,t,o,l.validation),l.styles?.conditionalFormats&&this.applyConditionalFormatting(e,t,o,l.styles.conditionalFormats)}}return o.jump?t+1:t}convertColor(e){if(e){if("object"==typeof e&&e.argb)return e;if("object"==typeof e&&"r"in e&&"g"in e&&"b"in e){return{argb:`FF${e.r.toString(16).padStart(2,"0")}${e.g.toString(16).padStart(2,"0")}${e.b.toString(16).padStart(2,"0")}`.toUpperCase()}}if("string"==typeof e){let t=e.replace("#","");return 3===t.length&&(t=t.split("").map(e=>e+e).join("")),6===t.length&&(t="FF"+t.toUpperCase()),{argb:t}}return"object"==typeof e&&"theme"in e?e:void 0}}convertStyle(e){if(!e)return{};const t={};if(e.font&&(t.font={name:e.font.family||e.font.name,size:e.font.size,bold:e.font.bold,italic:e.font.italic,underline:e.font.underline,color:this.convertColor(e.font.color)}),e.fill){const o=e.fill.pattern||"solid",s="solid"===o?e.fill.backgroundColor||e.fill.foregroundColor:e.fill.foregroundColor||e.fill.backgroundColor,r="solid"!==o?e.fill.backgroundColor:void 0;t.fill={type:e.fill.type||"pattern",pattern:o,fgColor:this.convertColor(s),bgColor:r?this.convertColor(r):void 0},t.fill.bgColor||delete t.fill.bgColor}if(e.border&&(t.border={},e.border.top&&(t.border.top={style:e.border.top.style,color:this.convertColor(e.border.top.color)}),e.border.left&&(t.border.left={style:e.border.left.style,color:this.convertColor(e.border.left.color)}),e.border.bottom&&(t.border.bottom={style:e.border.bottom.style,color:this.convertColor(e.border.bottom.color)}),e.border.right&&(t.border.right={style:e.border.right.style,color:this.convertColor(e.border.right.color)})),e.alignment){if(t.alignment={},void 0!==e.alignment.horizontal){["left","center","right","fill","justify","centerContinuous","distributed"].includes(e.alignment.horizontal)&&(t.alignment.horizontal=e.alignment.horizontal)}if(void 0!==e.alignment.vertical){["top","middle","bottom","distributed","justify"].includes(e.alignment.vertical)&&(t.alignment.vertical=e.alignment.vertical)}if(void 0!==e.alignment.wrapText&&(t.alignment.wrapText=Boolean(e.alignment.wrapText)),void 0!==e.alignment.shrinkToFit&&(t.alignment.shrinkToFit=Boolean(e.alignment.shrinkToFit)),void 0!==e.alignment.indent&&"number"==typeof e.alignment.indent&&(t.alignment.indent=e.alignment.indent),void 0!==e.alignment.textRotation&&"number"==typeof e.alignment.textRotation&&(t.alignment.textRotation=e.alignment.textRotation),void 0!==e.alignment.readingOrder){["left-to-right","right-to-left","context"].includes(e.alignment.readingOrder)&&(t.alignment.readingOrder=e.alignment.readingOrder)}0===Object.keys(t.alignment).length&&delete t.alignment}return e.numFmt&&(t.numFmt=e.numFmt),t}numberToColumnLetter(e){let t="";for(;e>0;)e--,t=String.fromCharCode(65+e%26)+t,e=Math.floor(e/26);return t}columnLetterToNumber(e){let t=0;for(let o=0;o<e.length;o++)t=26*t+(e.charCodeAt(o)-64);return t}async applyImage(e,t){try{let o,s,r;if("string"==typeof t.position.row){const e=t.position.row.match(/([A-Z]+)(\d+)/);e&&e[1]&&e[2]?(s=this.columnLetterToNumber(e[1]),o=parseInt(e[2],10)):(o=parseInt(t.position.row,10)||1,s="string"==typeof t.position.col?this.columnLetterToNumber(t.position.col):"number"==typeof t.position.col?t.position.col:1)}else o=t.position.row,s="string"==typeof t.position.col?this.columnLetterToNumber(t.position.col):"number"==typeof t.position.col?t.position.col:1;if("string"==typeof t.buffer){let e;if(t.buffer.startsWith("data:")){e=t.buffer.split(",")[1]||t.buffer}else e=t.buffer;const o=atob(e),s=new Uint8Array(o.length);for(let t=0;t<o.length;t++)s[t]=o.charCodeAt(t);r=s}else r=t.buffer instanceof ArrayBuffer?new Uint8Array(t.buffer):t.buffer;const i={tl:{col:s-1,row:o-1}};if(t.size&&(t.size.width&&t.size.height?i.ext={width:t.size.width,height:t.size.height}:t.size.scaleX&&t.size.scaleY&&(i.ext={width:100*(t.size.scaleX||1),height:100*(t.size.scaleY||1)})),e.addImage({buffer:r,extension:t.extension},i),t.hyperlink){e.getRow(o).getCell(s).value={text:t.description||"",hyperlink:t.hyperlink}}}catch(o){console.warn("Error adding image to worksheet:",o)}}applyRowGrouping(e,t,o,s=!1){for(let r=t;r<=o;r++){const o=e.getRow(r);if(o.outlineLevel||(o.outlineLevel=1),s&&r===t)try{o.collapsed=!0}catch{}}}applyColumnGrouping(e,t,o,s=!1){for(let r=t;r<=o;r++){const o=e.getColumn(r);if(o.outlineLevel||(o.outlineLevel=1),s&&r===t)try{o.collapsed=!0}catch{}}}applyExcelTable(e,t){try{const o=`${t.range.start}:${t.range.end}`,s={name:t.name,ref:o,headerRow:!1!==t.headerRow,totalsRow:!0===t.totalRow};t.style&&(s.style={theme:t.style,showFirstColumn:!1,showLastColumn:!1,showRowStripes:!0,showColumnStripes:!1}),t.columns&&t.columns.length>0&&(s.columns=t.columns.map(e=>({name:e.name,filterButton:!1!==e.filterButton,totalsRowFunction:e.totalsRowFunction||"none",totalsRowFormula:e.totalsRowFormula}))),e.addTable(s)}catch(o){console.warn("Error adding Excel table:",o)}}applyAdvancedPrintSettings(e){if(this.config.printHeadersFooters){const t={};if(this.config.printHeadersFooters.header){const e=this.config.printHeadersFooters.header.left||"",o=this.config.printHeadersFooters.header.center||"",s=this.config.printHeadersFooters.header.right||"";t.oddHeader=`${e}&C${o}&R${s}`}if(this.config.printHeadersFooters.footer){const e=this.config.printHeadersFooters.footer.left||"",o=this.config.printHeadersFooters.footer.center||"",s=this.config.printHeadersFooters.footer.right||"";t.oddFooter=`${e}&C${o}&R${s}`}Object.keys(t).length>0&&(e.headerFooter=t)}if(this.config.printRepeat){if(this.config.printRepeat.rows)if(Array.isArray(this.config.printRepeat.rows)){const t=this.config.printRepeat.rows.map(e=>e.toString()).join(":");e.pageSetup.printTitlesRow=`$${t}`}else e.pageSetup.printTitlesRow=`$${this.config.printRepeat.rows}`;if(this.config.printRepeat.columns)if(Array.isArray(this.config.printRepeat.columns)){const t=this.config.printRepeat.columns.map(e=>"number"==typeof e?this.numberToColumnLetter(e):e).join(":");e.pageSetup.printTitlesColumn=`$${t}`}else e.pageSetup.printTitlesColumn=`$${this.config.printRepeat.columns}`}}applyHiddenRowsColumns(e){for(const t of this.hiddenRows){e.getRow(t).hidden=!0}for(const t of this.hiddenColumns){e.getColumn(t).hidden=!0}}async applyPivotTable(e,t){try{if(t.sourceSheet){const o=e.workbook;if(!o.getWorksheet(t.sourceSheet))return void console.warn(`Source sheet "${t.sourceSheet}" not found for pivot table "${t.name}"`)}const o={name:t.name,ref:t.ref,sourceRange:t.sourceRange,fields:{}};t.fields.rows&&t.fields.rows.length>0&&(o.fields.rows=t.fields.rows),t.fields.columns&&t.fields.columns.length>0&&(o.fields.columns=t.fields.columns),t.fields.values&&t.fields.values.length>0&&(o.fields.values=t.fields.values.map(e=>({name:e.name,stat:e.stat}))),t.fields.filters&&t.fields.filters.length>0&&(o.fields.filters=t.fields.filters),t.options&&(o.options=t.options),e.addPivotTable?e.addPivotTable(o):console.warn("Pivot tables require ExcelJS 4.5.0+. Feature may not be fully supported.")}catch(o){console.warn("Error adding pivot table:",o)}}convertColorToExcelJS(e){if("string"==typeof e){if(e.startsWith("#")){return{argb:`FF${e.substring(1).toUpperCase()}`}}return{argb:"FF000000"}}if("r"in e&&"g"in e&&"b"in e){return{argb:`FF${[e.r,e.g,e.b].map(e=>{const t=e.toString(16);return 1===t.length?"0"+t:t}).join("").toUpperCase()}`}}return"theme"in e?{theme:e.theme}:{argb:"FF000000"}}applyViews(e){const t=[];if(this.config.freezePanes){const e={state:"frozen",xSplit:this.config.freezePanes.col-1,ySplit:this.config.freezePanes.row-1,topLeftCell:this.config.freezePanes.reference||this.numberToColumnLetter(this.config.freezePanes.col)+String(this.config.freezePanes.row),activeCell:this.config.freezePanes.reference||this.numberToColumnLetter(this.config.freezePanes.col)+String(this.config.freezePanes.row)};t.push(e)}else if(this.config.splitPanes){const e=this.config.splitPanes,o={state:"split",xSplit:e.xSplit||0,ySplit:e.ySplit||0};if(e.topLeftCell&&(o.topLeftCell=e.topLeftCell),e.activePane){const t={topLeft:"topLeft",topRight:"topRight",bottomLeft:"bottomLeft",bottomRight:"bottomRight"};o.activePane=t[e.activePane]||"topLeft"}t.push(o)}else if(this.config.views){const e=this.config.views,o={state:"pageBreakPreview"===e.state||"pageLayout"===e.state?"normal":e.state||"normal"};void 0!==e.zoomScale&&(o.zoomScale=e.zoomScale),void 0!==e.zoomScaleNormal&&(o.zoomScaleNormal=e.zoomScaleNormal),void 0!==e.showGridLines&&(o.showGridLines=e.showGridLines),void 0!==e.showRowColHeaders&&(o.showRowColHeaders=e.showRowColHeaders),void 0!==e.showRuler&&(o.showRuler=e.showRuler),void 0!==e.rightToLeft&&(o.rightToLeft=e.rightToLeft),t.push(o)}else this.config.zoom&&t.push({state:"normal",zoomScale:this.config.zoom});t.length>0&&(e.views=t)}getPredefinedStyle(e){if(this.customStyles&&this.customStyles[e])return this.customStyles[e]}getThemeStyle(e,t){if(!this.theme||!1===this.theme.autoApplySectionStyles)return;if(!this.customStyles)return;let o="";return"header"===e?o="__theme_header":"subHeader"===e?o="__theme_subHeader":"body"===e?o=void 0!==t&&t%2==1&&this.customStyles.__theme_body_alt?"__theme_body_alt":"__theme_body":"footer"===e&&(o="__theme_footer"),this.customStyles[o]}async applySlicer(e,t){try{console.warn("Slicers require advanced ExcelJS XML manipulation. Feature documented but not fully implemented.");const o="string"==typeof t.position.col?this.columnLetterToNumber(t.position.col):t.position.col;e.getRow(t.position.row).getCell(o).note=`Slicer: ${t.name} for table "${t.targetTable}" on column "${t.column}"`}catch(o){console.warn("Error adding slicer:",o)}}async applyWatermark(e,t){try{if(t.image){const o={...t.image,position:t.position?{row:"top"===t.position.vertical?1:"bottom"===t.position.vertical?1e3:500,col:"left"===t.position.horizontal?1:"right"===t.position.horizontal?20:10}:{row:500,col:10},size:t.image.size||{width:400,height:300,scaleX:t.opacity||.3,scaleY:t.opacity||.3}};await this.applyImage(e,o)}else if(t.text){const o=Math.floor((e.rowCount||100)/2),s=Math.floor((e.columnCount||20)/2),r=e.getRow(o).getCell(s);r.value=t.text,r.style={font:{size:t.fontSize||72,color:{argb:this.convertColorToExcelJS(t.fontColor||"#CCCCCC").argb},italic:!0},alignment:{horizontal:"center",vertical:"middle"}}}}catch(o){console.warn("Error adding watermark:",o)}}async applyDataConnection(e,t){try{console.warn("Data connections require advanced ExcelJS XML manipulation. Feature documented but not fully implemented."),e.model||(e.model={}),e.model.dataConnections||(e.model.dataConnections=[]),e.model.dataConnections.push({name:t.name,type:t.type,connectionString:t.connectionString,commandText:t.commandText,refresh:t.refresh,credentials:t.credentials?{username:t.credentials.username,integratedSecurity:t.credentials.integratedSecurity}:void 0})}catch(o){console.warn("Error adding data connection:",o)}}}var d=(e=>(e.WORKSHEET_ADDED="worksheetAdded",e.WORKSHEET_REMOVED="worksheetRemoved",e.WORKSHEET_UPDATED="worksheetUpdated",e.BUILD_STARTED="buildStarted",e.BUILD_PROGRESS="buildProgress",e.BUILD_COMPLETED="buildCompleted",e.BUILD_ERROR="buildError",e.DOWNLOAD_STARTED="downloadStarted",e.DOWNLOAD_PROGRESS="downloadProgress",e.DOWNLOAD_COMPLETED="downloadCompleted",e.DOWNLOAD_ERROR="downloadError",e))(d||{});class u{config;worksheets=new Map;currentWorksheet;isBuilding=!1;stats;eventEmitter;cellStyles=new Map;theme;constructor(e={}){this.config={enableValidation:!0,enableEvents:!0,enablePerformanceMonitoring:!1,maxWorksheets:255,maxRowsPerWorksheet:1048576,maxColumnsPerWorksheet:16384,memoryLimit:104857600,...e},this.stats=this.initializeStats(),this.eventEmitter=new o}addWorksheet(e,t={}){if(this.worksheets.has(e))throw new Error(`Worksheet "${e}" already exists`);const o={name:e,defaultRowHeight:20,defaultColWidth:10,...this.config.defaultWorksheetConfig,...t},s=new h(o);return this.worksheets.set(e,s),this.currentWorksheet=s,this.emitEvent(d.WORKSHEET_ADDED,{worksheetName:e}),s}getWorksheet(e){return this.worksheets.get(e)}removeWorksheet(e){const t=this.worksheets.get(e);return!!t&&(this.worksheets.delete(e),this.currentWorksheet===t&&(this.currentWorksheet=void 0),this.emitEvent(d.WORKSHEET_REMOVED,{worksheetName:e}),!0)}setCurrentWorksheet(e){const t=this.worksheets.get(e);return!!t&&(this.currentWorksheet=t,!0)}async build(t={}){if(this.isBuilding)return{success:!1,error:{type:c.BUILD_ERROR,message:"Build already in progress",stack:(new Error).stack||""}};this.isBuilding=!0;const o=Date.now();try{this.emitEvent(d.BUILD_STARTED);const s=new e.Workbook;this.config.metadata&&(s.creator=this.config.metadata.author||"Han Excel Builder",s.lastModifiedBy=this.config.metadata.author||"Han Excel Builder",s.created=this.config.metadata.created||new Date,s.modified=this.config.metadata.modified||new Date,this.config.metadata.title&&(s.title=this.config.metadata.title),this.config.metadata.subject&&(s.subject=this.config.metadata.subject),this.config.metadata.keywords&&(s.keywords=this.config.metadata.keywords),this.config.metadata.category&&(s.category=this.config.metadata.category),this.config.metadata.description&&(s.description=this.config.metadata.description)),this.theme&&this.applyTheme(s,this.theme);for(const[e,t]of this.cellStyles.entries())this.addStyleToWorkbook(s,e,t);for(const e of this.worksheets.values())await e.build(s,t);const r=await s.xlsx.writeBuffer({compression:t.compressionLevel||6}),i=Date.now();this.stats.buildTime=i-o,this.stats.fileSize=r.byteLength;const n={success:!0,data:r};return this.emitEvent(d.BUILD_COMPLETED,{buildTime:this.stats.buildTime,fileSize:this.stats.fileSize}),n}catch(s){const e={success:!1,error:{type:c.BUILD_ERROR,message:s instanceof Error?s.message:"Unknown build error",stack:s instanceof Error&&s.stack||""}};return this.emitEvent(d.BUILD_ERROR,{error:e.error}),e}finally{this.isBuilding=!1}}async generateAndDownload(e,o={}){const s=await this.build(o);if(!s.success)return s;try{this.emitEvent(d.DOWNLOAD_STARTED,{fileName:e});const r=new Blob([s.data],{type:o.mimeType||"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});return t(r,e),this.emitEvent(d.DOWNLOAD_COMPLETED,{fileName:e}),{success:!0,data:void 0}}catch(r){const e={success:!1,error:{type:c.BUILD_ERROR,message:r instanceof Error?r.message:"Download failed",stack:r instanceof Error&&r.stack||""}};return this.emitEvent(d.DOWNLOAD_ERROR,{error:e.error}),e}}async saveToFile(e,t={}){const o=await this.build(t);if(!o.success)return o;try{if("undefined"!=typeof window){return{success:!1,error:{type:c.BUILD_ERROR,message:"saveToFile() is only available in Node.js. Use generateAndDownload() in the browser.",stack:""}}}this.emitEvent(d.DOWNLOAD_STARTED,{fileName:e});const r=await(async()=>{try{const e=await Promise.resolve().then(()=>require("./__vite-browser-external-e7aec059.cjs")),t=await Promise.resolve().then(()=>require("./__vite-browser-external-e7aec059.cjs"));return{fs:e,path:t,Buffer:(await Promise.resolve().then(()=>require("./index-0188b143.cjs")).then(e=>e.index)).Buffer}}catch{throw new Error("Node.js modules not available. saveToFile() requires Node.js environment.")}})();if(!1!==t.createDir){const t=r.path.dirname(e);try{await r.fs.mkdir(t,{recursive:!0})}catch(s){if("EEXIST"!==s?.code)throw s}}const i=r.Buffer.from(o.data);return await r.fs.writeFile(e,i,{encoding:t.encoding||"binary"}),this.emitEvent(d.DOWNLOAD_COMPLETED,{fileName:e}),{success:!0,data:void 0}}catch(s){const e={success:!1,error:{type:c.BUILD_ERROR,message:s instanceof Error?s.message:"Failed to save file",stack:s instanceof Error&&s.stack||""}};return this.emitEvent(d.DOWNLOAD_ERROR,{error:e.error}),e}}async saveToStream(e,t={}){const o=await this.build(t);if(!o.success)return o;try{if("undefined"!=typeof window){return{success:!1,error:{type:c.BUILD_ERROR,message:"saveToStream() is only available in Node.js.",stack:""}}}this.emitEvent(d.DOWNLOAD_STARTED,{fileName:"stream"});const t=(await Promise.resolve().then(()=>require("./index-0188b143.cjs")).then(e=>e.index)).Buffer.from(o.data);return new Promise(o=>{e.write(t,e=>{if(e){const t={success:!1,error:{type:c.BUILD_ERROR,message:e.message||"Failed to write to stream",stack:e.stack||""}};this.emitEvent(d.DOWNLOAD_ERROR,{error:t.error}),o(t)}else this.emitEvent(d.DOWNLOAD_COMPLETED,{fileName:"stream"}),o({success:!0,data:void 0})})})}catch(s){const e={success:!1,error:{type:c.BUILD_ERROR,message:s instanceof Error?s.message:"Failed to save to stream",stack:s instanceof Error&&s.stack||""}};return this.emitEvent(d.DOWNLOAD_ERROR,{error:e.error}),e}}async toBuffer(e={}){return this.build(e)}async toBlob(e={}){const t=await this.build(e);if(!t.success)return t;return{success:!0,data:new Blob([t.data],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"})}}validate(){const e=[];0===this.worksheets.size&&e.push("No worksheets found");for(const[t,o]of this.worksheets.entries()){const s=o.validate();s.success||e.push(`Worksheet "${t}": ${s.error?.message}`)}return e.length>0?{success:!1,error:{type:c.VALIDATION_ERROR,message:e.join("; "),stack:(new Error).stack||""}}:{success:!0,data:!0}}clear(){this.worksheets.clear(),this.currentWorksheet=void 0,this.cellStyles.clear(),this.theme=void 0}getStats(){return{...this.stats}}addCellStyle(e,t){return this.cellStyles.set(e,t),this}getCellStyle(e){return this.cellStyles.get(e)}setTheme(e){return this.theme=e,this}getTheme(){return this.theme}on(e,t){return this.eventEmitter.on(e,t)}off(e,t){return this.eventEmitter.off(e,t)}removeAllListeners(e){e?this.eventEmitter.offAll(e):this.eventEmitter.clear()}emitEvent(e,t){const o={type:e,data:t||{},timestamp:new Date};this.eventEmitter.emitSync(o)}initializeStats(){return{totalWorksheets:0,totalCells:0,memoryUsage:0,buildTime:0,fileSize:0,stylesUsed:0,formulasUsed:0,conditionalFormatsUsed:0,performance:{headersTime:0,dataTime:0,stylesTime:0,writeTime:0}}}applyTheme(e,t){if(!e.model)return;const o={name:t.name||"Custom Theme"};t.colors&&(o.colors={},t.colors.dark1&&(o.colors.dark1=this.convertColorToTheme(t.colors.dark1)),t.colors.light1&&(o.colors.light1=this.convertColorToTheme(t.colors.light1)),t.colors.dark2&&(o.colors.dark2=this.convertColorToTheme(t.colors.dark2)),t.colors.light2&&(o.colors.light2=this.convertColorToTheme(t.colors.light2)),t.colors.accent1&&(o.colors.accent1=this.convertColorToTheme(t.colors.accent1)),t.colors.accent2&&(o.colors.accent2=this.convertColorToTheme(t.colors.accent2)),t.colors.accent3&&(o.colors.accent3=this.convertColorToTheme(t.colors.accent3)),t.colors.accent4&&(o.colors.accent4=this.convertColorToTheme(t.colors.accent4)),t.colors.accent5&&(o.colors.accent5=this.convertColorToTheme(t.colors.accent5)),t.colors.accent6&&(o.colors.accent6=this.convertColorToTheme(t.colors.accent6)),t.colors.hyperlink&&(o.colors.hyperlink=this.convertColorToTheme(t.colors.hyperlink)),t.colors.followedHyperlink&&(o.colors.followedHyperlink=this.convertColorToTheme(t.colors.followedHyperlink))),t.fonts&&(o.fonts={},t.fonts.major&&(o.fonts.major={latin:t.fonts.major.latin||"Calibri",eastAsian:t.fonts.major.eastAsian||t.fonts.major.latin||"Calibri",complexScript:t.fonts.major.complexScript||t.fonts.major.latin||"Calibri"}),t.fonts.minor&&(o.fonts.minor={latin:t.fonts.minor.latin||"Calibri",eastAsian:t.fonts.minor.eastAsian||t.fonts.minor.latin||"Calibri",complexScript:t.fonts.minor.complexScript||t.fonts.minor.latin||"Calibri"})),e.model=e.model||{},e.model.theme=o}convertColorToTheme(e){return"string"==typeof e?e.startsWith("#")?e.substring(1):e:"r"in e&&"g"in e&&"b"in e?`${e.r.toString(16).padStart(2,"0")}${e.g.toString(16).padStart(2,"0")}${e.b.toString(16).padStart(2,"0")}`:"000000"}addStyleToWorkbook(e,t,o){e.__customStyles=e.__customStyles||{},e.__customStyles[t]=o}}var m=(e=>(e.WORKSHEET="worksheet",e.DETAILED="detailed",e.FLAT="flat",e))(m||{});class f{style={};constructor(){this.style.alignment={horizontal:i.CENTER,vertical:n.MIDDLE,wrapText:!0,shrinkToFit:!0}}static create(){return new f}fontName(e){return this.style.font||(this.style.font={}),this.style.font.name=e,this}fontSize(e){return this.style.font||(this.style.font={}),this.style.font.size=e,this}fontStyle(e){return this.style.font||(this.style.font={}),this.style.font.style=e,this}fontColor(e){return this.style.font||(this.style.font={}),this.style.font.color=e,this}fontBold(){return this.style.font||(this.style.font={}),this.style.font.bold=!0,this}fontItalic(){return this.style.font||(this.style.font={}),this.style.font.italic=!0,this}fontUnderline(){return this.style.font||(this.style.font={}),this.style.font.underline=!0,this}border(e,t){this.style.border||(this.style.border={});const o={style:e};return void 0!==t&&(o.color=t),this.style.border.top=o,this.style.border.left=o,this.style.border.bottom=o,this.style.border.right=o,this}borderTop(e,t){this.style.border||(this.style.border={});const o={style:e};return void 0!==t&&(o.color=t),this.style.border.top=o,this}borderLeft(e,t){this.style.border||(this.style.border={});const o={style:e};return void 0!==t&&(o.color=t),this.style.border.left=o,this}borderBottom(e,t){this.style.border||(this.style.border={});const o={style:e};return void 0!==t&&(o.color=t),this.style.border.bottom=o,this}borderRight(e,t){this.style.border||(this.style.border={});const o={style:e};return void 0!==t&&(o.color=t),this.style.border.right=o,this}backgroundColor(e){return this.style.fill||(this.style.fill={type:"pattern"}),this.style.fill.backgroundColor=e,this.style.fill.pattern="solid",this}horizontalAlign(e){return this.style.alignment||(this.style.alignment={}),this.style.alignment.horizontal=e,this}verticalAlign(e){return this.style.alignment||(this.style.alignment={}),this.style.alignment.vertical=e,this}centerAlign(){return this.style.alignment||(this.style.alignment={}),this.style.alignment.horizontal=i.CENTER,this.style.alignment.vertical=n.MIDDLE,this}leftAlign(){return this.style.alignment||(this.style.alignment={}),this.style.alignment.horizontal=i.LEFT,this}rightAlign(){return this.style.alignment||(this.style.alignment={}),this.style.alignment.horizontal=i.RIGHT,this}wrapText(){return this.style.alignment||(this.style.alignment={}),this.style.alignment.wrapText=!0,this}numberFormat(e){return this.style.numberFormat=e,this}striped(){return this.style.striped=!0,this}conditionalFormat(e){return this.style.conditionalFormats||(this.style.conditionalFormats=[]),this.style.conditionalFormats.push(e),this}build(){return this.style}reset(){return this.style={},this.style.alignment={horizontal:i.CENTER,vertical:n.MIDDLE,wrapText:!0},this}clone(){const e=new f;return e.style=JSON.parse(JSON.stringify(this.style)),e}}var p=(e=>(e.CREATED="created",e.UPDATED="updated",e.DELETED="deleted",e.STYLED="styled",e.VALIDATED="validated",e))(p||{}),y=(e=>(e.CREATED="created",e.UPDATED="updated",e.DELETED="deleted",e.TABLE_ADDED="tableAdded",e.TABLE_REMOVED="tableRemoved",e.CELL_ADDED="cellAdded",e.CELL_UPDATED="cellUpdated",e.CELL_DELETED="cellDeleted",e))(y||{}),g=(e=>(e.HEADER="header",e.SUBHEADER="subheader",e.DATA="data",e.FOOTER="footer",e.TOTAL="total",e.HIGHLIGHT="highlight",e.WARNING="warning",e.ERROR="error",e.SUCCESS="success",e.INFO="info",e))(g||{});exports.BorderStyle=l,exports.BuilderEventType=d,exports.CellEventType=p,exports.CellType=s,exports.ErrorType=c,exports.EventEmitter=o,exports.ExcelBuilder=u,exports.ExcelReader=class{static async fromBuffer(t,o={}){const s=Date.now();try{const i=new e.Workbook;await i.xlsx.load(t);const n=o.outputFormat||m.WORKSHEET,l=Date.now()-s;let a;switch(n){case m.DETAILED:a=this.convertToDetailedFormat(i,o);break;case m.FLAT:a=this.convertToFlatFormat(i,o);break;case m.WORKSHEET:default:a=this.convertWorkbookToJson(i,o)}if(o.mapper)try{switch(n){case m.DETAILED:case m.FLAT:case m.WORKSHEET:}a=o.mapper(a)}catch(r){return{...{success:!1,error:{type:c.VALIDATION_ERROR,message:r instanceof Error?`Mapper function error: ${r.message}`:"Error in mapper function",stack:r instanceof Error&&r.stack||""}},processingTime:Date.now()-s}}return{success:!0,data:a,processingTime:l}}catch(i){return{success:!1,error:{success:!1,error:{type:c.VALIDATION_ERROR,message:i instanceof Error?i.message:"Error reading Excel file",stack:i instanceof Error&&i.stack||""}}.error,processingTime:Date.now()-s}}}static async fromBlob(e,t={}){const o=await e.arrayBuffer();return this.fromBuffer(o,t)}static async fromFile(e,t={}){return this.fromBlob(e,t)}static async fromPath(e,t={}){try{const o=await Promise.resolve().then(()=>require("./__vite-browser-external-e7aec059.cjs")),s=await o.readFile(e),r=s.buffer.slice(s.byteOffset,s.byteOffset+s.byteLength);return this.fromBuffer(r,t)}catch(o){const e=o instanceof Error&&(o.message.includes("Cannot find module")||o.message.includes("fs")||"undefined"!=typeof window);return{...{success:!1,error:{type:c.VALIDATION_ERROR,message:e?"fromPath() method requires Node.js environment. Use fromFile() or fromBlob() in browser.":o instanceof Error?o.message:"Error reading file from path",stack:o instanceof Error&&o.stack||""}},processingTime:0}}}static convertWorkbookToJson(e,t){const{includeEmptyRows:o=!1,useFirstRowAsHeaders:s=!1,headers:r,sheetName:i,startRow:n=1,endRow:l,startColumn:a=1,endColumn:c,includeFormatting:h=!1,includeFormulas:d=!1,datesAsISO:u=!0}=t,m={title:e.title,author:e.creator,company:e.company,created:e.created,modified:e.modified,description:e.description};let f=[];if(void 0!==i)if("number"==typeof i){const t=e.worksheets[i];t&&f.push(t)}else{const t=e.getWorksheet(i);t&&f.push(t)}else f=e.worksheets;const p=f.map(e=>{const t={includeEmptyRows:o??!1,useFirstRowAsHeaders:s??!1,startRow:n??1,startColumn:a??1,includeFormatting:h??!1,includeFormulas:d??!1,datesAsISO:u??!0};return void 0!==r&&(t.headers=r),void 0!==l&&(t.endRow=l),void 0!==c&&(t.endColumn=c),this.convertSheetToJson(e,t)}),y={sheets:p,totalSheets:p.length};return Object.values(m).some(e=>null!=e)&&(y.metadata=m),y}static convertSheetToJson(e,t){const{includeEmptyRows:o,useFirstRowAsHeaders:s,headers:r,startRow:i,endRow:n,startColumn:l,endColumn:a,includeFormatting:c,includeFormulas:h,datesAsISO:d}=t,u=[];let m,f=0;const p=Math.max(i,1),y=n||e.rowCount||e.lastRow?.number||1,g=Math.max(l,1),b=a||e.columnCount||e.lastColumn?.number||1;for(let w=p;w<=y;w++){const t=e.getRow(w),i=[];let n,l=!1;for(let e=g;e<=b;e++){const s=t.getCell(e);if(!s.value&&!o)continue;const r=this.convertCellToJson(s,{includeFormatting:c,includeFormulas:h,datesAsISO:d});i.push(r),l=!0}if(i.length>f&&(f=i.length),!l&&!o)continue;if(s&&w===p){m=i.map(e=>r&&Array.isArray(r)?r[i.indexOf(e)]||String(e.value||""):r&&"object"==typeof r&&r[g+i.indexOf(e)]||String(e.value||""));continue}s&&m&&(n={},i.forEach((e,t)=>{const o=m[t]||`column_${t+1}`;n[o]=e.value}));const a={rowNumber:w,cells:i};n&&(a.data=n),u.push(a)}const v={name:e.name,index:e.id||0,rows:u,totalRows:u.length,totalColumns:f};return m&&(v.headers=m),v}static convertCellToJson(t,o){const{includeFormatting:s,includeFormulas:r,datesAsISO:i}=o;let n,l=t.value;if(t.type===e.ValueType.Null||null===t.value||void 0===t.value)l=null,n="null";else if(t.type===e.ValueType.Number)l=t.value,n="number";else if(t.type===e.ValueType.String)l=t.value,n="string";else if(t.type===e.ValueType.Date){const e=t.value;l=i?e.toISOString():e,n="date"}else if(t.type===e.ValueType.Boolean)l=t.value,n="boolean";else if(t.type===e.ValueType.Formula)r&&t.formula?(l=t.result||t.value,n="formula"):(l=t.result||t.value,n="number"==typeof t.result?"number":"string"==typeof t.result?"string":"unknown");else if(t.type===e.ValueType.Hyperlink){const e=t.value;l="object"==typeof e&&null!==e?e.text||e.hyperlink||t.value:e,n="hyperlink"}else l=t.value,n="unknown";const a={value:l,type:n,reference:t.address};if(s&&t.numFmt&&(a.formattedValue=String(l)),r&&t.formula&&(a.formula=t.formula),t.note){const e=t.note;if("string"==typeof e)a.comment=e;else if(e&&"object"==typeof e&&"texts"in e){const t=e.texts;Array.isArray(t)&&t.length>0&&(a.comment=t.map(e=>e.text||"").join(""))}else e&&"object"==typeof e&&"text"in e&&(a.comment=String(e.text))}return a}static convertToDetailedFormat(e,t){const{includeEmptyRows:o=!1,includeFormatting:s=!1,includeFormulas:r=!1,datesAsISO:i=!0,sheetName:n,startRow:l=1,endRow:a,startColumn:c=1,endColumn:h}=t,d=[],u={title:e.title,author:e.creator,company:e.company,created:e.created,modified:e.modified,description:e.description};let m=[];if(void 0!==n)if("number"==typeof n){const t=e.worksheets[n];t&&m.push(t)}else{const t=e.getWorksheet(n);t&&m.push(t)}else m=e.worksheets;for(const p of m){const e=Math.max(l,1),t=a||p.rowCount||p.lastRow?.number||1,n=Math.max(c,1),u=h||p.columnCount||p.lastColumn?.number||1;for(let l=e;l<=t;l++){const e=p.getRow(l);for(let t=n;t<=u;t++){const n=e.getCell(t);if(!n.value&&!o)continue;const a=this.numberToColumnLetter(t),c=this.getCellValue(n,{includeFormatting:s,includeFormulas:r,datesAsISO:i}),h={value:c.value,text:String(c.value??""),column:t,columnLetter:a,row:l,reference:n.address||`${a}${l}`,sheet:p.name};if(c.type&&(h.type=c.type),c.formattedValue&&(h.formattedValue=c.formattedValue),c.formula&&(h.formula=c.formula),n.note){const e=n.note;if("string"==typeof e)h.comment=e;else if(e&&"object"==typeof e&&"texts"in e){const t=e.texts;Array.isArray(t)&&t.length>0&&(h.comment=t.map(e=>e.text||"").join(""))}else e&&"object"==typeof e&&"text"in e&&(h.comment=String(e.text))}d.push(h)}}}const f={cells:d,totalCells:d.length};return Object.values(u).some(e=>null!=e)&&(f.metadata=u),f}static convertToFlatFormat(e,t){const{useFirstRowAsHeaders:o=!1,includeEmptyRows:s=!1,sheetName:r,startRow:i=1,endRow:n,startColumn:l=1,endColumn:a}=t,c={title:e.title,author:e.creator,company:e.company,created:e.created,modified:e.modified,description:e.description};let h=[];if(void 0!==r)if("number"==typeof r){const t=e.worksheets[r];t&&h.push(t)}else{const t=e.getWorksheet(r);t&&h.push(t)}else h=e.worksheets;if(1===h.length){const e=h[0],t={useFirstRowAsHeaders:o,includeEmptyRows:s,startRow:i};void 0!==n&&(t.endRow=n),void 0!==l&&(t.startColumn=l),void 0!==a&&(t.endColumn=a);return this.convertSheetToFlat(e,t)}const d={};for(const m of h){const e={useFirstRowAsHeaders:o,includeEmptyRows:s,startRow:i};void 0!==n&&(e.endRow=n),void 0!==l&&(e.startColumn=l),void 0!==a&&(e.endColumn=a);const t=this.convertSheetToFlat(m,e);d[m.name]=t}const u={sheets:d,totalSheets:Object.keys(d).length};return Object.values(c).some(e=>null!=e)&&(u.metadata=c),u}static convertSheetToFlat(e,t){const{useFirstRowAsHeaders:o,includeEmptyRows:s,startRow:r,endRow:i,startColumn:n,endColumn:l}=t,a=Math.max(r,1),c=i||e.rowCount||e.lastRow?.number||1,h=Math.max(n||1,1),d=l||e.columnCount||e.lastColumn?.number||1,u=[];let m;if(o){const t=e.getRow(a);m=[];for(let e=h;e<=d;e++){const o=t.getCell(e);m.push(String(o.value||`Column${e}`))}}for(let p=o?a+1:a;p<=c;p++){const t=e.getRow(p),r=[];let i=!1;for(let e=h;e<=d;e++){const o=t.getCell(e),s=this.getCellValue(o,{includeFormatting:!1,includeFormulas:!1,datesAsISO:!0});r.push(s.value),null!==s.value&&void 0!==s.value&&""!==s.value&&(i=!0)}if(i||s)if(o&&m){const e={};m.forEach((t,o)=>{e[t]=r[o]}),u.push(e)}else u.push(r)}const f={data:u,totalRows:u.length,sheet:e.name};return m&&(f.headers=m),f}static getCellValue(t,o){const{includeFormatting:s,includeFormulas:r,datesAsISO:i}=o;let n,l,a,c=t.value;if(t.type===e.ValueType.Null||null===t.value||void 0===t.value)c=null,n="null";else if(t.type===e.ValueType.Number)c=t.value,n="number";else if(t.type===e.ValueType.String)c=t.value,n="string";else if(t.type===e.ValueType.Date){const e=t.value;c=i?e.toISOString():e,n="date"}else if(t.type===e.ValueType.Boolean)c=t.value,n="boolean";else if(t.type===e.ValueType.Formula)r&&t.formula?(a=t.formula,c=t.result||t.value,n="formula"):(c=t.result||t.value,n="number"==typeof t.result?"number":"string"==typeof t.result?"string":"unknown");else if(t.type===e.ValueType.Hyperlink){const e=t.value;c="object"==typeof e&&null!==e?e.text||e.hyperlink||t.value:e,n="hyperlink"}else c=t.value,n="unknown";return s&&t.numFmt&&(l=String(c)),{value:c,type:n,...l&&{formattedValue:l},...a&&{formula:a}}}static numberToColumnLetter(e){let t="";for(;e>0;)e--,t=String.fromCharCode(65+e%26)+t,e=Math.floor(e/26);return t}},exports.FontStyle=a,exports.HorizontalAlignment=i,exports.NumberFormat=r,exports.StyleBuilder=f,exports.StylePreset=g,exports.VerticalAlignment=n,exports.Worksheet=h,exports.WorksheetEventType=y,exports.default=u;
//# sourceMappingURL=han-excel.cjs.js.map
