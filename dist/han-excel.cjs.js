"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const e=require("exceljs"),t=require("file-saver");class s{listeners=new Map;on(e,t,s={}){this.listeners.has(e)||this.listeners.set(e,[]);const r={type:e,listener:t,options:{once:!1,async:!1,priority:0,stopPropagation:!1,...s},id:this.generateId(),active:!0,timestamp:new Date};return this.listeners.get(e).push(r),this.listeners.get(e).sort((e,t)=>(t.options.priority||0)-(e.options.priority||0)),r.id}once(e,t,s={}){return this.on(e,t,{...s,once:!0})}off(e,t){const s=this.listeners.get(e);if(!s)return!1;const r=s.findIndex(e=>e.id===t);return-1!==r&&(s.splice(r,1),!0)}offAll(e){const t=this.listeners.get(e);if(!t)return 0;const s=t.length;return this.listeners.delete(e),s}async emit(e){const t=e.type||"default",s=this.listeners.get(t);if(!s||0===s.length)return;const r=s.filter(e=>e.active);for(const l of r)try{if(l.options.once&&(l.active=!1),l.options.async?await l.listener(e):l.listener(e),l.options.stopPropagation)break}catch(o){console.error(`Error in event listener for ${t}:`,o)}this.cleanupInactiveListeners(t)}emitSync(e){const t=e.type||"default",s=this.listeners.get(t);if(!s||0===s.length)return;const r=s.filter(e=>e.active);for(const l of r)try{if(l.options.once&&(l.active=!1),l.listener(e),l.options.stopPropagation)break}catch(o){console.error(`Error in event listener for ${t}:`,o)}this.cleanupInactiveListeners(t)}clear(){this.listeners.clear()}getListeners(e){return this.listeners.get(e)||[]}getListenerCount(e){return this.listeners.get(e)?.length||0}getEventTypes(){return Array.from(this.listeners.keys())}generateId(){return Math.random().toString(36).substr(2,9)}cleanupInactiveListeners(e){const t=this.listeners.get(e);if(t){const s=t.filter(e=>e.active);s.length!==t.length&&this.listeners.set(e,s)}}}var r=(e=>(e.STRING="string",e.NUMBER="number",e.BOOLEAN="boolean",e.DATE="date",e.PERCENTAGE="percentage",e.CURRENCY="currency",e.LINK="link",e.FORMULA="formula",e))(r||{}),o=(e=>(e.GENERAL="General",e.NUMBER="#,##0",e.NUMBER_DECIMALS="#,##0.00",e.CURRENCY="$#,##0.00",e.CURRENCY_INTEGER="$#,##0",e.PERCENTAGE="0%",e.PERCENTAGE_DECIMALS="0.00%",e.DATE="dd/mm/yyyy",e.DATE_TIME="dd/mm/yyyy hh:mm",e.TIME="hh:mm:ss",e.CUSTOM="custom",e))(o||{}),l=(e=>(e.LEFT="left",e.CENTER="center",e.RIGHT="right",e.FILL="fill",e.JUSTIFY="justify",e.CENTER_CONTINUOUS="centerContinuous",e.DISTRIBUTED="distributed",e))(l||{}),n=(e=>(e.TOP="top",e.MIDDLE="middle",e.BOTTOM="bottom",e.DISTRIBUTED="distributed",e.JUSTIFY="justify",e))(n||{}),i=(e=>(e.THIN="thin",e.MEDIUM="medium",e.THICK="thick",e.DOTTED="dotted",e.DASHED="dashed",e.DOUBLE="double",e.HAIR="hair",e.MEDIUM_DASHED="mediumDashed",e.DASH_DOT="dashDot",e.MEDIUM_DASH_DOT="mediumDashDot",e.DASH_DOT_DOT="dashDotDot",e.MEDIUM_DASH_DOT_DOT="mediumDashDotDot",e.SLANT_DASH_DOT="slantDashDot",e))(i||{}),a=(e=>(e.NORMAL="normal",e.BOLD="bold",e.ITALIC="italic",e.BOLD_ITALIC="bold italic",e))(a||{}),h=(e=>(e.VALIDATION_ERROR="VALIDATION_ERROR",e.BUILD_ERROR="BUILD_ERROR",e.STYLE_ERROR="STYLE_ERROR",e.WORKSHEET_ERROR="WORKSHEET_ERROR",e.CELL_ERROR="CELL_ERROR",e))(h||{});class c{config;tables=[];currentRow=1;currentCol=1;headerPointers=new Map;isBuilt=!1;headers=[];subHeaders=[];body=[];footers=[];constructor(e){this.config=e}addHeader(e){return this.headers.push(e),this}addSubHeaders(e){return this.subHeaders.push(...e),this}addRow(e){return Array.isArray(e)?this.body.push(...e):this.body.push(e),this}addFooter(e){return Array.isArray(e)?this.footers.push(...e):this.footers.push(e),this}addTable(e={}){const t={name:e.name||`Table_${this.tables.length+1}`,headers:e.headers||[],subHeaders:e.subHeaders||[],body:e.body||[],footers:e.footers||[],showBorders:!1!==e.showBorders,showStripes:!1!==e.showStripes,style:e.style||"TableStyleLight1",...e};return this.tables.push(t),this}finalizeTable(){0===this.tables.length&&this.addTable();const e=this.tables[this.tables.length-1];if(!e)throw new Error("No se pudo obtener la tabla actual");return this.headers.length>0&&(e.headers=[...e.headers||[],...this.headers]),this.subHeaders.length>0&&(e.subHeaders=[...e.subHeaders||[],...this.subHeaders]),this.body.length>0&&(e.body=[...e.body||[],...this.body]),this.footers.length>0&&(e.footers=[...e.footers||[],...this.footers]),this.headers=[],this.subHeaders=[],this.body=[],this.footers=[],this}getTable(e){return this.tables.find(t=>t.name===e)}async build(e,t={}){const s=e.addWorksheet(this.config.name,{properties:{defaultRowHeight:this.config.defaultRowHeight||20,tabColor:this.config.tabColor},pageSetup:this.config.pageSetup});let r=1;if(this.tables.length>0)for(let o=0;o<this.tables.length;o++){const e=this.tables[o];e&&(r=await this.buildTable(s,e,r,o>0))}else r=await this.buildLegacyContent(s,r);this.isBuilt=!0}async buildTable(e,t,s,r=!1){let o=s;if(r&&(o+=2),t.headers&&t.headers.length>0)for(const l of t.headers){if(e.addRow([this.processCellValue(l)]),l.mergeCell){const s=this.calculateTableMaxColumns(t);e.mergeCells(o,1,o,s)}l.styles&&e.getRow(o).eachCell(e=>{e.style=this.convertStyle(l.styles)}),this.applyCellDimensions(e,o,1,l),o++}if(t.subHeaders&&t.subHeaders.length>0&&(o=this.buildNestedHeaders(e,o,t.subHeaders)),t.body&&t.body.length>0)for(const l of t.body)o=this.addDataRowRecursive(e,o,l);if(t.footers&&t.footers.length>0)for(const l of t.footers)o=this.addFooterRow(e,o,l);return(t.showBorders||t.showStripes)&&this.applyTableStyle(e,t,s,o-1),o}async buildLegacyContent(e,t){let s=t;this.headers.length>0&&this.headers.forEach(t=>{e.addRow([this.processCellValue(t)]),t.mergeCell&&e.mergeCells(s,1,s,this.getMaxColumns()||1),t.styles&&e.getRow(s).eachCell(e=>{e.style=this.convertStyle(t.styles)}),this.applyCellDimensions(e,s,1,t),s++}),this.subHeaders.length>0&&(s=this.buildNestedHeaders(e,s,this.subHeaders));for(const r of this.body)s=this.addDataRowRecursive(e,s,r);if(this.footers.length>0)for(const r of this.footers)s=this.addFooterRow(e,s,r);return s}calculateTableMaxColumns(e){let t=0;if(e.subHeaders&&e.subHeaders.length>0)for(const s of e.subHeaders)t+=this.calculateHeaderColSpan(s);return t||1}applyTableStyle(e,t,s,r){const o=this.calculateTableMaxColumns(t);if(t.showBorders)for(let l=s;l<=r;l++)for(let t=1;t<=o;t++){const s=e.getRow(l).getCell(t);s.style||(s.style={}),s.style.border||(s.style.border={top:{style:"thin",color:{argb:"FF8EAADB"}},left:{style:"thin",color:{argb:"FF8EAADB"}},bottom:{style:"thin",color:{argb:"FF8EAADB"}},right:{style:"thin",color:{argb:"FF8EAADB"}}})}if(t.showStripes)for(let l=s;l<=r;l++)if((l-s)%2==1)for(let t=1;t<=o;t++){const s=e.getRow(l).getCell(t);s.style||(s.style={}),s.style.fill||(s.style.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFF2F2F2"}})}}buildNestedHeaders(e,t,s){let r=t;const o=this.getMaxHeaderDepth(s);for(let l=0;l<o;l++){const t=e.getRow(r);let o=1;for(const n of s)if(0===l){const s=this.getHeaderAtDepth(n,l,o),i=t.getCell(o);i.value=this.processCellValue(n),s.style&&(i.style=this.convertStyle(s.style)),this.applyCellDimensions(e,r,o,n),o+=s.colSpan}else if(n.children&&n.children.length>0)for(const s of n.children){const l=t.getCell(o);l.value=this.processCellValue(s),(s.styles||n.styles)&&(l.style=this.convertStyle(s.styles||n.styles)),this.applyCellDimensions(e,r,o,s),o+=this.calculateHeaderColSpan(s)}else{t.getCell(o).value=null,o+=1}r++}return this.applyAllMerges(e,t,r-1,s),r}getHeaderAtDepth(e,t,s){const r=this.calculateHeaderColSpan(e);if(0===t){const t=r>1?{start:s,end:s+r-1}:null;return{value:"string"==typeof e.value?e.value:String(e.value||""),style:e.styles,colSpan:r,mergeRange:t}}if(e.children&&e.children.length>0){const r=e.children[t];if(r){const t=this.calculateHeaderColSpan(r),o=t>1?{start:s,end:s+t-1}:null;return{value:"string"==typeof r.value?r.value:String(r.value||""),style:r.styles||e.styles,colSpan:t,mergeRange:o}}}return{value:null,style:null,colSpan:1}}applyAllMerges(e,t,s,r){this.getMaxHeaderDepth(r)<=1||this.applySmartMerges(e,t,s,r)}applySmartMerges(e,t,s,r){if(this.getMaxHeaderDepth(r)<=1)return;let o=1;for(const l of r)this.applySmartMergesForHeader(e,t,s,l,o),o+=this.calculateHeaderColSpan(l)}applySmartMergesForHeader(e,t,s,r,o){const l=this.calculateHeaderColSpan(r);if(r.children&&0!==r.children.length){l>1&&e.mergeCells(t,o,t,o+l-1);let n=o;for(const o of r.children)this.applySmartMergesForHeader(e,t+1,s,o,n),n+=this.calculateHeaderColSpan(o)}else e.mergeCells(t,o,s,o+l-1)}calculateHeaderColSpan(e){return e.children&&0!==e.children.length?e.children.reduce((e,t)=>e+this.calculateHeaderColSpan(t),0):1}getMaxHeaderDepth(e){let t=1;for(const s of e)if(s.children&&s.children.length>0){const e=this.getMaxHeaderDepth(s.children);t=Math.max(t,e+1)}return t}getMaxColumns(){let e=0;for(const t of this.subHeaders)e+=this.calculateHeaderColSpan(t);return e}validate(){return this.headers.length||this.body.length?{success:!0,data:!0}:{success:!1,error:{type:h.VALIDATION_ERROR,message:"La hoja no tiene datos"}}}calculateDataColumnPositions(){const e={};let t=1;for(const s of this.subHeaders)if(s.children&&s.children.length>0)for(const r of s.children)r.key&&(e[r.key]=t),r.value&&(e[String(r.value)]=t),t++;else s.key&&(e[s.key]=t),s.value&&(e[String(s.value)]=t),t++;return e}addFooterRow(e,t,s){const r=this.calculateDataColumnPositions();let o;s.key&&r[s.key]?o=r[s.key]:s.header&&r[s.header]&&(o=r[s.header]),void 0===o&&(o=1);const l=e.getRow(t),n=l.getCell(o);if(n.value=this.processCellValue(s),s.styles&&(n.style=this.convertStyle(s.styles)),s.numberFormat&&(n.numFmt=s.numberFormat),this.applyCellDimensions(e,t,o,s),s.mergeCell&&s.mergeTo&&e.mergeCells(t,o,t,s.mergeTo),s.children&&s.children.length>0)for(const i of s.children)if(i){let s;if(i.key&&r[i.key]?s=r[i.key]:i.header&&r[i.header]&&(s=r[i.header]),void 0!==s){const r=l.getCell(s);r.value=this.processCellValue(i),i.styles&&(r.style=this.convertStyle(i.styles)),i.numberFormat&&(r.numFmt=i.numberFormat),this.applyCellDimensions(e,t,s,i)}}return s.jump?t+1:t}applyCellDimensions(e,t,s,r){if(void 0!==r.rowHeight){e.getRow(t).height=r.rowHeight}if(void 0!==r.colWidth){e.getColumn(s).width=r.colWidth}}processCellValue(e){if(e.link||e.type===r.LINK){const t=e.link||("string"==typeof e.value?e.value:"");if(!t||""===t.trim())return e.value;const s=e.mask||e.value||t;return{text:String(s),hyperlink:t}}return e.value}addDataRowRecursive(e,t,s){const r=this.calculateDataColumnPositions();let o;s.key&&r[s.key]?o=r[s.key]:s.header&&r[s.header]&&(o=r[s.header]),void 0===o&&(o=1);const l=e.getRow(t),n=l.getCell(o);if(n.value=this.processCellValue(s),s.styles&&(n.style=this.convertStyle(s.styles)),s.numberFormat&&(n.numFmt=s.numberFormat),this.applyCellDimensions(e,t,o,s),s.children&&s.children.length>0)for(const i of s.children)if(i){let s;if(i.key&&r[i.key]?s=r[i.key]:i.header&&r[i.header]&&(s=r[i.header]),void 0!==s){const r=l.getCell(s);r.value=this.processCellValue(i),i.styles&&(r.style=this.convertStyle(i.styles)),i.numberFormat&&(r.numFmt=i.numberFormat),this.applyCellDimensions(e,t,s,i)}}return s.jump?t+1:t}convertColor(e){if(e){if("object"==typeof e&&e.argb)return e;if("object"==typeof e&&"r"in e&&"g"in e&&"b"in e){return{argb:`FF${e.r.toString(16).padStart(2,"0")}${e.g.toString(16).padStart(2,"0")}${e.b.toString(16).padStart(2,"0")}`.toUpperCase()}}if("string"==typeof e){let t=e.replace("#","");return 3===t.length&&(t=t.split("").map(e=>e+e).join("")),6===t.length&&(t="FF"+t.toUpperCase()),{argb:t}}return"object"==typeof e&&"theme"in e?e:void 0}}convertStyle(e){if(!e)return{};const t={};if(e.font&&(t.font={name:e.font.family||e.font.name,size:e.font.size,bold:e.font.bold,italic:e.font.italic,underline:e.font.underline,color:this.convertColor(e.font.color)}),e.fill){const s=e.fill.pattern||"solid",r="solid"===s?e.fill.backgroundColor||e.fill.foregroundColor:e.fill.foregroundColor||e.fill.backgroundColor,o="solid"!==s?e.fill.backgroundColor:void 0;t.fill={type:e.fill.type||"pattern",pattern:s,fgColor:this.convertColor(r),bgColor:o?this.convertColor(o):void 0},t.fill.bgColor||delete t.fill.bgColor}if(e.border&&(t.border={},e.border.top&&(t.border.top={style:e.border.top.style,color:this.convertColor(e.border.top.color)}),e.border.left&&(t.border.left={style:e.border.left.style,color:this.convertColor(e.border.left.color)}),e.border.bottom&&(t.border.bottom={style:e.border.bottom.style,color:this.convertColor(e.border.bottom.color)}),e.border.right&&(t.border.right={style:e.border.right.style,color:this.convertColor(e.border.right.color)})),e.alignment){if(t.alignment={},void 0!==e.alignment.horizontal){["left","center","right","fill","justify","centerContinuous","distributed"].includes(e.alignment.horizontal)&&(t.alignment.horizontal=e.alignment.horizontal)}if(void 0!==e.alignment.vertical){["top","middle","bottom","distributed","justify"].includes(e.alignment.vertical)&&(t.alignment.vertical=e.alignment.vertical)}if(void 0!==e.alignment.wrapText&&(t.alignment.wrapText=Boolean(e.alignment.wrapText)),void 0!==e.alignment.shrinkToFit&&(t.alignment.shrinkToFit=Boolean(e.alignment.shrinkToFit)),void 0!==e.alignment.indent&&"number"==typeof e.alignment.indent&&(t.alignment.indent=e.alignment.indent),void 0!==e.alignment.textRotation&&"number"==typeof e.alignment.textRotation&&(t.alignment.textRotation=e.alignment.textRotation),void 0!==e.alignment.readingOrder){["left-to-right","right-to-left","context"].includes(e.alignment.readingOrder)&&(t.alignment.readingOrder=e.alignment.readingOrder)}0===Object.keys(t.alignment).length&&delete t.alignment}return e.numFmt&&(t.numFmt=e.numFmt),t}}var d=(e=>(e.WORKSHEET_ADDED="worksheetAdded",e.WORKSHEET_REMOVED="worksheetRemoved",e.WORKSHEET_UPDATED="worksheetUpdated",e.BUILD_STARTED="buildStarted",e.BUILD_PROGRESS="buildProgress",e.BUILD_COMPLETED="buildCompleted",e.BUILD_ERROR="buildError",e.DOWNLOAD_STARTED="downloadStarted",e.DOWNLOAD_PROGRESS="downloadProgress",e.DOWNLOAD_COMPLETED="downloadCompleted",e.DOWNLOAD_ERROR="downloadError",e))(d||{});class u{config;worksheets=new Map;currentWorksheet;isBuilding=!1;stats;eventEmitter;constructor(e={}){this.config={enableValidation:!0,enableEvents:!0,enablePerformanceMonitoring:!1,maxWorksheets:255,maxRowsPerWorksheet:1048576,maxColumnsPerWorksheet:16384,memoryLimit:104857600,...e},this.stats=this.initializeStats(),this.eventEmitter=new s}addWorksheet(e,t={}){if(this.worksheets.has(e))throw new Error(`Worksheet "${e}" already exists`);const s={name:e,defaultRowHeight:20,defaultColWidth:10,...this.config.defaultWorksheetConfig,...t},r=new c(s);return this.worksheets.set(e,r),this.currentWorksheet=r,this.emitEvent(d.WORKSHEET_ADDED,{worksheetName:e}),r}getWorksheet(e){return this.worksheets.get(e)}removeWorksheet(e){const t=this.worksheets.get(e);return!!t&&(this.worksheets.delete(e),this.currentWorksheet===t&&(this.currentWorksheet=void 0),this.emitEvent(d.WORKSHEET_REMOVED,{worksheetName:e}),!0)}setCurrentWorksheet(e){const t=this.worksheets.get(e);return!!t&&(this.currentWorksheet=t,!0)}async build(t={}){if(this.isBuilding)return{success:!1,error:{type:h.BUILD_ERROR,message:"Build already in progress",stack:(new Error).stack||""}};this.isBuilding=!0;const s=Date.now();try{this.emitEvent(d.BUILD_STARTED);const r=new e.Workbook;this.config.metadata&&(r.creator=this.config.metadata.author||"Han Excel Builder",r.lastModifiedBy=this.config.metadata.author||"Han Excel Builder",r.created=this.config.metadata.created||new Date,r.modified=this.config.metadata.modified||new Date,this.config.metadata.title&&(r.title=this.config.metadata.title),this.config.metadata.subject&&(r.subject=this.config.metadata.subject),this.config.metadata.keywords&&(r.keywords=this.config.metadata.keywords),this.config.metadata.category&&(r.category=this.config.metadata.category),this.config.metadata.description&&(r.description=this.config.metadata.description));for(const e of this.worksheets.values())await e.build(r,t);const o=await r.xlsx.writeBuffer({compression:t.compressionLevel||6}),l=Date.now();this.stats.buildTime=l-s,this.stats.fileSize=o.byteLength;const n={success:!0,data:o};return this.emitEvent(d.BUILD_COMPLETED,{buildTime:this.stats.buildTime,fileSize:this.stats.fileSize}),n}catch(r){const e={success:!1,error:{type:h.BUILD_ERROR,message:r instanceof Error?r.message:"Unknown build error",stack:r instanceof Error&&r.stack||""}};return this.emitEvent(d.BUILD_ERROR,{error:e.error}),e}finally{this.isBuilding=!1}}async generateAndDownload(e,s={}){const r=await this.build(s);if(!r.success)return r;try{this.emitEvent(d.DOWNLOAD_STARTED,{fileName:e});const o=new Blob([r.data],{type:s.mimeType||"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});return t(o,e),this.emitEvent(d.DOWNLOAD_COMPLETED,{fileName:e}),{success:!0,data:void 0}}catch(o){const e={success:!1,error:{type:h.BUILD_ERROR,message:o instanceof Error?o.message:"Download failed",stack:o instanceof Error&&o.stack||""}};return this.emitEvent(d.DOWNLOAD_ERROR,{error:e.error}),e}}async toBuffer(e={}){return this.build(e)}async toBlob(e={}){const t=await this.build(e);if(!t.success)return t;return{success:!0,data:new Blob([t.data],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"})}}validate(){const e=[];0===this.worksheets.size&&e.push("No worksheets found");for(const[t,s]of this.worksheets.entries()){const r=s.validate();r.success||e.push(`Worksheet "${t}": ${r.error?.message}`)}return e.length>0?{success:!1,error:{type:h.VALIDATION_ERROR,message:e.join("; "),stack:(new Error).stack||""}}:{success:!0,data:!0}}clear(){this.worksheets.clear(),this.currentWorksheet=void 0}getStats(){return{...this.stats}}on(e,t){return this.eventEmitter.on(e,t)}off(e,t){return this.eventEmitter.off(e,t)}removeAllListeners(e){e?this.eventEmitter.offAll(e):this.eventEmitter.clear()}emitEvent(e,t){const s={type:e,data:t||{},timestamp:new Date};this.eventEmitter.emitSync(s)}initializeStats(){return{totalWorksheets:0,totalCells:0,memoryUsage:0,buildTime:0,fileSize:0,stylesUsed:0,formulasUsed:0,conditionalFormatsUsed:0,performance:{headersTime:0,dataTime:0,stylesTime:0,writeTime:0}}}}var m=(e=>(e.WORKSHEET="worksheet",e.DETAILED="detailed",e.FLAT="flat",e))(m||{});class f{style={};constructor(){this.style.alignment={horizontal:l.CENTER,vertical:n.MIDDLE,wrapText:!0,shrinkToFit:!0}}static create(){return new f}fontName(e){return this.style.font||(this.style.font={}),this.style.font.name=e,this}fontSize(e){return this.style.font||(this.style.font={}),this.style.font.size=e,this}fontStyle(e){return this.style.font||(this.style.font={}),this.style.font.style=e,this}fontColor(e){return this.style.font||(this.style.font={}),this.style.font.color=e,this}fontBold(){return this.style.font||(this.style.font={}),this.style.font.bold=!0,this}fontItalic(){return this.style.font||(this.style.font={}),this.style.font.italic=!0,this}fontUnderline(){return this.style.font||(this.style.font={}),this.style.font.underline=!0,this}border(e,t){this.style.border||(this.style.border={});const s={style:e};return void 0!==t&&(s.color=t),this.style.border.top=s,this.style.border.left=s,this.style.border.bottom=s,this.style.border.right=s,this}borderTop(e,t){this.style.border||(this.style.border={});const s={style:e};return void 0!==t&&(s.color=t),this.style.border.top=s,this}borderLeft(e,t){this.style.border||(this.style.border={});const s={style:e};return void 0!==t&&(s.color=t),this.style.border.left=s,this}borderBottom(e,t){this.style.border||(this.style.border={});const s={style:e};return void 0!==t&&(s.color=t),this.style.border.bottom=s,this}borderRight(e,t){this.style.border||(this.style.border={});const s={style:e};return void 0!==t&&(s.color=t),this.style.border.right=s,this}backgroundColor(e){return this.style.fill||(this.style.fill={type:"pattern"}),this.style.fill.backgroundColor=e,this.style.fill.pattern="solid",this}horizontalAlign(e){return this.style.alignment||(this.style.alignment={}),this.style.alignment.horizontal=e,this}verticalAlign(e){return this.style.alignment||(this.style.alignment={}),this.style.alignment.vertical=e,this}centerAlign(){return this.style.alignment||(this.style.alignment={}),this.style.alignment.horizontal=l.CENTER,this.style.alignment.vertical=n.MIDDLE,this}leftAlign(){return this.style.alignment||(this.style.alignment={}),this.style.alignment.horizontal=l.LEFT,this}rightAlign(){return this.style.alignment||(this.style.alignment={}),this.style.alignment.horizontal=l.RIGHT,this}wrapText(){return this.style.alignment||(this.style.alignment={}),this.style.alignment.wrapText=!0,this}numberFormat(e){return this.style.numberFormat=e,this}striped(){return this.style.striped=!0,this}conditionalFormat(e){return this.style.conditionalFormats||(this.style.conditionalFormats=[]),this.style.conditionalFormats.push(e),this}build(){return this.style}reset(){return this.style={},this.style.alignment={horizontal:l.CENTER,vertical:n.MIDDLE,wrapText:!0},this}clone(){const e=new f;return e.style=JSON.parse(JSON.stringify(this.style)),e}}var y=(e=>(e.CREATED="created",e.UPDATED="updated",e.DELETED="deleted",e.STYLED="styled",e.VALIDATED="validated",e))(y||{}),g=(e=>(e.CREATED="created",e.UPDATED="updated",e.DELETED="deleted",e.TABLE_ADDED="tableAdded",e.TABLE_REMOVED="tableRemoved",e.CELL_ADDED="cellAdded",e.CELL_UPDATED="cellUpdated",e.CELL_DELETED="cellDeleted",e))(g||{}),p=(e=>(e.HEADER="header",e.SUBHEADER="subheader",e.DATA="data",e.FOOTER="footer",e.TOTAL="total",e.HIGHLIGHT="highlight",e.WARNING="warning",e.ERROR="error",e.SUCCESS="success",e.INFO="info",e))(p||{});exports.BorderStyle=i,exports.BuilderEventType=d,exports.CellEventType=y,exports.CellType=r,exports.ErrorType=h,exports.EventEmitter=s,exports.ExcelBuilder=u,exports.ExcelReader=class{static async fromBuffer(t,s={}){const r=Date.now();try{const l=new e.Workbook;await l.xlsx.load(t);const n=s.outputFormat||m.WORKSHEET,i=Date.now()-r;let a;switch(n){case m.DETAILED:a=this.convertToDetailedFormat(l,s);break;case m.FLAT:a=this.convertToFlatFormat(l,s);break;case m.WORKSHEET:default:a=this.convertWorkbookToJson(l,s)}if(s.mapper)try{switch(n){case m.DETAILED:case m.FLAT:case m.WORKSHEET:}a=s.mapper(a)}catch(o){return{...{success:!1,error:{type:h.VALIDATION_ERROR,message:o instanceof Error?`Mapper function error: ${o.message}`:"Error in mapper function",stack:o instanceof Error&&o.stack||""}},processingTime:Date.now()-r}}return{success:!0,data:a,processingTime:i}}catch(l){return{success:!1,error:{success:!1,error:{type:h.VALIDATION_ERROR,message:l instanceof Error?l.message:"Error reading Excel file",stack:l instanceof Error&&l.stack||""}}.error,processingTime:Date.now()-r}}}static async fromBlob(e,t={}){const s=await e.arrayBuffer();return this.fromBuffer(s,t)}static async fromFile(e,t={}){return this.fromBlob(e,t)}static async fromPath(e,t={}){try{const s=await Promise.resolve().then(()=>require("./__vite-browser-external-e7aec059.cjs")),r=await s.readFile(e),o=r.buffer.slice(r.byteOffset,r.byteOffset+r.byteLength);return this.fromBuffer(o,t)}catch(s){const e=s instanceof Error&&(s.message.includes("Cannot find module")||s.message.includes("fs")||"undefined"!=typeof window);return{...{success:!1,error:{type:h.VALIDATION_ERROR,message:e?"fromPath() method requires Node.js environment. Use fromFile() or fromBlob() in browser.":s instanceof Error?s.message:"Error reading file from path",stack:s instanceof Error&&s.stack||""}},processingTime:0}}}static convertWorkbookToJson(e,t){const{includeEmptyRows:s=!1,useFirstRowAsHeaders:r=!1,headers:o,sheetName:l,startRow:n=1,endRow:i,startColumn:a=1,endColumn:h,includeFormatting:c=!1,includeFormulas:d=!1,datesAsISO:u=!0}=t,m={title:e.title,author:e.creator,company:e.company,created:e.created,modified:e.modified,description:e.description};let f=[];if(void 0!==l)if("number"==typeof l){const t=e.worksheets[l];t&&f.push(t)}else{const t=e.getWorksheet(l);t&&f.push(t)}else f=e.worksheets;const y=f.map(e=>{const t={includeEmptyRows:s??!1,useFirstRowAsHeaders:r??!1,startRow:n??1,startColumn:a??1,includeFormatting:c??!1,includeFormulas:d??!1,datesAsISO:u??!0};return void 0!==o&&(t.headers=o),void 0!==i&&(t.endRow=i),void 0!==h&&(t.endColumn=h),this.convertSheetToJson(e,t)}),g={sheets:y,totalSheets:y.length};return Object.values(m).some(e=>null!=e)&&(g.metadata=m),g}static convertSheetToJson(e,t){const{includeEmptyRows:s,useFirstRowAsHeaders:r,headers:o,startRow:l,endRow:n,startColumn:i,endColumn:a,includeFormatting:h,includeFormulas:c,datesAsISO:d}=t,u=[];let m,f=0;const y=Math.max(l,1),g=n||e.rowCount||e.lastRow?.number||1,p=Math.max(i,1),b=a||e.columnCount||e.lastColumn?.number||1;for(let v=y;v<=g;v++){const t=e.getRow(v),l=[];let n,i=!1;for(let e=p;e<=b;e++){const r=t.getCell(e);if(!r.value&&!s)continue;const o=this.convertCellToJson(r,{includeFormatting:h,includeFormulas:c,datesAsISO:d});l.push(o),i=!0}if(l.length>f&&(f=l.length),!i&&!s)continue;if(r&&v===y){m=l.map(e=>o&&Array.isArray(o)?o[l.indexOf(e)]||String(e.value||""):o&&"object"==typeof o&&o[p+l.indexOf(e)]||String(e.value||""));continue}r&&m&&(n={},l.forEach((e,t)=>{const s=m[t]||`column_${t+1}`;n[s]=e.value}));const a={rowNumber:v,cells:l};n&&(a.data=n),u.push(a)}const E={name:e.name,index:e.id||0,rows:u,totalRows:u.length,totalColumns:f};return m&&(E.headers=m),E}static convertCellToJson(t,s){const{includeFormatting:r,includeFormulas:o,datesAsISO:l}=s;let n,i=t.value;if(t.type===e.ValueType.Null||null===t.value||void 0===t.value)i=null,n="null";else if(t.type===e.ValueType.Number)i=t.value,n="number";else if(t.type===e.ValueType.String)i=t.value,n="string";else if(t.type===e.ValueType.Date){const e=t.value;i=l?e.toISOString():e,n="date"}else if(t.type===e.ValueType.Boolean)i=t.value,n="boolean";else if(t.type===e.ValueType.Formula)o&&t.formula?(i=t.result||t.value,n="formula"):(i=t.result||t.value,n="number"==typeof t.result?"number":"string"==typeof t.result?"string":"unknown");else if(t.type===e.ValueType.Hyperlink){const e=t.value;i="object"==typeof e&&null!==e?e.text||e.hyperlink||t.value:e,n="hyperlink"}else i=t.value,n="unknown";const a={value:i,type:n,reference:t.address};return r&&t.numFmt&&(a.formattedValue=String(i)),o&&t.formula&&(a.formula=t.formula),a}static convertToDetailedFormat(e,t){const{includeEmptyRows:s=!1,includeFormatting:r=!1,includeFormulas:o=!1,datesAsISO:l=!0,sheetName:n,startRow:i=1,endRow:a,startColumn:h=1,endColumn:c}=t,d=[],u={title:e.title,author:e.creator,company:e.company,created:e.created,modified:e.modified,description:e.description};let m=[];if(void 0!==n)if("number"==typeof n){const t=e.worksheets[n];t&&m.push(t)}else{const t=e.getWorksheet(n);t&&m.push(t)}else m=e.worksheets;for(const y of m){const e=Math.max(i,1),t=a||y.rowCount||y.lastRow?.number||1,n=Math.max(h,1),u=c||y.columnCount||y.lastColumn?.number||1;for(let i=e;i<=t;i++){const e=y.getRow(i);for(let t=n;t<=u;t++){const n=e.getCell(t);if(!n.value&&!s)continue;const a=this.numberToColumnLetter(t),h=this.getCellValue(n,{includeFormatting:r,includeFormulas:o,datesAsISO:l}),c={value:h.value,text:String(h.value??""),column:t,columnLetter:a,row:i,reference:n.address||`${a}${i}`,sheet:y.name};h.type&&(c.type=h.type),h.formattedValue&&(c.formattedValue=h.formattedValue),h.formula&&(c.formula=h.formula),d.push(c)}}}const f={cells:d,totalCells:d.length};return Object.values(u).some(e=>null!=e)&&(f.metadata=u),f}static convertToFlatFormat(e,t){const{useFirstRowAsHeaders:s=!1,includeEmptyRows:r=!1,sheetName:o,startRow:l=1,endRow:n,startColumn:i=1,endColumn:a}=t,h={title:e.title,author:e.creator,company:e.company,created:e.created,modified:e.modified,description:e.description};let c=[];if(void 0!==o)if("number"==typeof o){const t=e.worksheets[o];t&&c.push(t)}else{const t=e.getWorksheet(o);t&&c.push(t)}else c=e.worksheets;if(1===c.length){const e=c[0],t={useFirstRowAsHeaders:s,includeEmptyRows:r,startRow:l};void 0!==n&&(t.endRow=n),void 0!==i&&(t.startColumn=i),void 0!==a&&(t.endColumn=a);return this.convertSheetToFlat(e,t)}const d={};for(const m of c){const e={useFirstRowAsHeaders:s,includeEmptyRows:r,startRow:l};void 0!==n&&(e.endRow=n),void 0!==i&&(e.startColumn=i),void 0!==a&&(e.endColumn=a);const t=this.convertSheetToFlat(m,e);d[m.name]=t}const u={sheets:d,totalSheets:Object.keys(d).length};return Object.values(h).some(e=>null!=e)&&(u.metadata=h),u}static convertSheetToFlat(e,t){const{useFirstRowAsHeaders:s,includeEmptyRows:r,startRow:o,endRow:l,startColumn:n,endColumn:i}=t,a=Math.max(o,1),h=l||e.rowCount||e.lastRow?.number||1,c=Math.max(n||1,1),d=i||e.columnCount||e.lastColumn?.number||1,u=[];let m;if(s){const t=e.getRow(a);m=[];for(let e=c;e<=d;e++){const s=t.getCell(e);m.push(String(s.value||`Column${e}`))}}for(let y=s?a+1:a;y<=h;y++){const t=e.getRow(y),o=[];let l=!1;for(let e=c;e<=d;e++){const s=t.getCell(e),r=this.getCellValue(s,{includeFormatting:!1,includeFormulas:!1,datesAsISO:!0});o.push(r.value),null!==r.value&&void 0!==r.value&&""!==r.value&&(l=!0)}if(l||r)if(s&&m){const e={};m.forEach((t,s)=>{e[t]=o[s]}),u.push(e)}else u.push(o)}const f={data:u,totalRows:u.length,sheet:e.name};return m&&(f.headers=m),f}static getCellValue(t,s){const{includeFormatting:r,includeFormulas:o,datesAsISO:l}=s;let n,i,a,h=t.value;if(t.type===e.ValueType.Null||null===t.value||void 0===t.value)h=null,n="null";else if(t.type===e.ValueType.Number)h=t.value,n="number";else if(t.type===e.ValueType.String)h=t.value,n="string";else if(t.type===e.ValueType.Date){const e=t.value;h=l?e.toISOString():e,n="date"}else if(t.type===e.ValueType.Boolean)h=t.value,n="boolean";else if(t.type===e.ValueType.Formula)o&&t.formula?(a=t.formula,h=t.result||t.value,n="formula"):(h=t.result||t.value,n="number"==typeof t.result?"number":"string"==typeof t.result?"string":"unknown");else if(t.type===e.ValueType.Hyperlink){const e=t.value;h="object"==typeof e&&null!==e?e.text||e.hyperlink||t.value:e,n="hyperlink"}else h=t.value,n="unknown";return r&&t.numFmt&&(i=String(h)),{value:h,type:n,...i&&{formattedValue:i},...a&&{formula:a}}}static numberToColumnLetter(e){let t="";for(;e>0;)e--,t=String.fromCharCode(65+e%26)+t,e=Math.floor(e/26);return t}},exports.FontStyle=a,exports.HorizontalAlignment=l,exports.NumberFormat=o,exports.StyleBuilder=f,exports.StylePreset=p,exports.VerticalAlignment=n,exports.Worksheet=c,exports.WorksheetEventType=g,exports.default=u;
//# sourceMappingURL=han-excel.cjs.js.map
